<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer2Peer NoteSharing Marketplace</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        body {
            background: radial-gradient(circle at top right, #0f172a, #1e293b);
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
        }
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="text-slate-200">

<div class="max-w-4xl mx-auto px-6 py-12">

    <h1 class="text-4xl font-bold text-center text-cyan-400 mb-6">
        Peer2Peer Notes
    </h1>

    <div class="glass p-6 rounded-2xl">

        <!-- ID Section -->
        <div class="mb-6">
            <p class="text-xs text-gray-400">Your ID</p>
            <h2 id="my-id" class="text-xl text-cyan-400">Loading...</h2>
        </div>

        <!-- Connect -->
        <div class="flex gap-2 mb-6">
            <input id="receiver-id" placeholder="Enter Peer ID"
                class="bg-gray-900 px-3 py-2 rounded w-full text-sm">
            <button onclick="connectToPeer()"
                class="bg-cyan-500 px-4 rounded">Connect</button>
        </div>

        <div class="grid md:grid-cols-2 gap-6">

            <!-- My Files -->
            <div>
                <h3 class="text-sm mb-2">My Notes</h3>
                <input type="file" id="file-input" class="hidden">
                <button onclick="document.getElementById('file-input').click()"
                    class="w-full border border-dashed p-2 mb-3">
                    + Add File
                </button>

                <div id="my-files-list"></div>
            </div>

            <!-- Marketplace -->
            <div>
                <h3 class="text-sm mb-2">Peer Files</h3>
                <div id="note-gallery"></div>
            </div>

        </div>
    </div>
</div>

<script>

const peer = new Peer();
let conn = null;
let myFiles = [];
let remoteFiles = [];

// My ID
peer.on('open', id => {
    document.getElementById('my-id').innerText = id;
});

// Incoming connection
peer.on('connection', connection => {
    conn = connection;
    setupConnection();
});

// Connect manually
function connectToPeer() {
    const id = document.getElementById('receiver-id').value;
    if (!id) return alert("Enter ID");
    conn = peer.connect(id, { reliable: true });
    setupConnection();
}

// Setup connection
function setupConnection() {

    conn.on('open', () => {
        console.log("Connected!");
        sendManifest();
    });

    conn.on('data', async data => {

        if (data.type === 'MANIFEST') {
            remoteFiles = data.files;
            renderFiles(remoteFiles);
        }

        else if (data.type === 'REQUEST') {
            const fileObj = myFiles.find(f => f.name === data.name);

            if (fileObj) {
                const buffer = await fileObj.file.arrayBuffer();

                conn.send({
                    type: 'FILE',
                    name: fileObj.name,
                    mime: fileObj.file.type,
                    buffer: buffer
                });
            }
        }

        else if (data.type === 'FILE') {
            const blob = new Blob([data.buffer], { type: data.mime });

            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = data.name;
            a.click();
        }
    });
}

// Add file
document.getElementById('file-input').onchange = (e) => {
    const file = e.target.files[0];

    if (file) {
        myFiles.push({
            name: file.name,
            size: (file.size / 1024).toFixed(1) + " KB",
            file: file
        });

        updateMyFiles();

        if (conn && conn.open) sendManifest();
    }
};

// Update UI
function updateMyFiles() {
    const list = document.getElementById('my-files-list');

    list.innerHTML = myFiles.map(f => `
        <div class="bg-gray-800 p-2 mb-2 rounded flex justify-between">
            <span>${f.name}</span>
            <span class="text-xs">${f.size}</span>
        </div>
    `).join('');
}

// Send file list
function sendManifest() {
    conn.send({
        type: 'MANIFEST',
        files: myFiles.map(f => ({
            name: f.name,
            size: f.size
        }))
    });
}

// Render peer files
function renderFiles(files) {
    const gallery = document.getElementById('note-gallery');

    if (files.length === 0) {
        gallery.innerHTML = "No files available";
        return;
    }

    gallery.innerHTML = files.map(f => `
        <div class="bg-gray-800 p-2 mb-2 rounded">
            <p>${f.name}</p>
            <p class="text-xs">${f.size}</p>
            <button onclick="requestFile('${f.name}')"
                class="bg-cyan-500 px-2 py-1 mt-1 text-xs rounded">
                Download
            </button>
        </div>
    `).join('');
}

// Request file
function requestFile(name) {
    if (conn && conn.open) {
        conn.send({
            type: 'REQUEST',
            name: name
        });
    } else {
        alert("Not connected!");
    }
}

</script>

</body>
</html>
